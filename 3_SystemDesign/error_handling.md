---
title: "エラーハンドリング"
updated: "2024-01-01T00:00:00Z"
owner: "TBD"
---

# エラーハンドリング

## エラー分類

### クライアントエラー（4xx）

- **400 Bad Request**: リクエストが不正（バリデーションエラー等）
- **401 Unauthorized**: 認証が必要
- **403 Forbidden**: 権限が不足
- **404 Not Found**: リソースが見つからない
- **409 Conflict**: リソースの競合（例: メールアドレス重複）
- **429 Too Many Requests**: レート制限超過

### サーバーエラー（5xx）

- **500 Internal Server Error**: サーバー内部エラー
- **502 Bad Gateway**: ゲートウェイエラー
- **503 Service Unavailable**: サービス利用不可（メンテナンス中等）
- **504 Gateway Timeout**: ゲートウェイタイムアウト

## リトライ戦略

### 自動リトライ対象

- **ネットワークエラー**: タイムアウト、接続エラー
- **一時的なサーバーエラー**: 500, 502, 503, 504
- **レート制限**: 429（指数バックオフでリトライ）

### リトライしないエラー

- **クライアントエラー**: 400, 401, 403, 404, 409
- **認証エラー**: 401（トークンリフレッシュは別途実装）

### リトライ実装

- **指数バックオフ**: 初回1秒、2回目2秒、3回目4秒...
- **最大リトライ回数**: 3回
- **ジッター**: リトライ間隔にランダムな遅延を追加（同時リトライの回避）

## ログ方針

### ログレベル

- **ERROR**: エラーが発生し、ユーザーに影響がある
- **WARN**: 警告（エラーではないが、注意が必要）
- **INFO**: 情報（通常の処理フロー）
- **DEBUG**: デバッグ情報（開発環境のみ）

### ログ形式

- **構造化ログ**: JSON形式で出力
- **必須フィールド**: `timestamp`, `level`, `message`, `request_id`, `user_id`（該当する場合）
- **エラー時**: `error_code`, `error_message`, `stack_trace` を追加

### ログ保持期間

- **エラーログ**: 90日間
- **アクセスログ**: 30日間
- **監査ログ**: 1年間

## ユーザー通知

### エラーメッセージ

- **明確性**: ユーザーが理解できる明確なメッセージ
- **実行可能性**: ユーザーが次に取るべき行動を示す
- **技術的詳細の非表示**: スタックトレース等の技術的詳細はユーザーに表示しない

### 通知方法

- **即座に表示**: バリデーションエラー等は即座に表示
- **トースト通知**: 一時的なエラー（ネットワークエラー等）はトースト通知
- **モーダル**: 重大なエラー（セッション期限切れ等）はモーダルで表示

## エラーハンドリングフロー

### フロントエンド

1. API呼び出し
2. エラーレスポンス受信
3. エラーコードに基づいて処理を分岐
4. ユーザーに適切なメッセージを表示
5. 必要に応じてログに記録

### バックエンド

1. リクエスト受信
2. バリデーション
3. ビジネスロジック実行
4. エラー発生時、エラーログを記録
5. 適切なHTTPステータスコードとエラーレスポンスを返却

## 関連ドキュメント

- [API仕様](./api_specifications.md)
- [セキュリティとプライバシー](../2_NonFunctionalRequirements/security_and_privacy.md)
- [外部サービス連携](./external_services.md)

## 追記履歴

| 日時 | 変更者 | 要旨 |
|------|--------|------|
| 2024-01-01 | TBD | 初版作成 |

## TODO

- [ ] エラーハンドリングライブラリを選定
- [ ] エラーログの集約・分析方法を定義
- [ ] ユーザー向けエラーメッセージのテンプレートを作成
- [ ] エラー監視・アラート設定を定義
- [ ] エラーハンドリングのテスト計画を策定

